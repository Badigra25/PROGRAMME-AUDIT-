<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programme d'audit interne</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
       html, body, .wrapper { height: 100%; margin: 0; padding: 0; background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .wrapper { display: flex; flex-direction: column; height: 100vh;}

        /* --- Connexion stylée --- */
        .login-container {
            background: #fff;
            padding: 60px 50px 50px 50px;
            border-radius: 22px;
            box-shadow: 0 8px 32px #4a80c730, 0 1.5px 6px #0056b320;
            max-width: 490px;
            min-width: 350px;
            margin: 0 auto;
            position: absolute;
            left: 50%; top: 52%;
            transform: translate(-50%, -53%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.25s;
        }
        .login-container:hover {
            box-shadow: 0 10px 40px #4a80c750, 0 2px 12px #0056b350;
        }
        .login-header img { width: 150px; margin-bottom: 25px; }
        .login-container h1 {
            color: #0056b3;
            margin-bottom: 12px;
            font-size: 2.1rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
        }
        .login-container h2 {
            color: #6c757d;
            font-size: 1.15rem;
            font-weight: bold;
            margin-bottom: 32px;
            text-transform: uppercase;
            letter-spacing: 0.11em;
        }
        .login-form input {
            width: 100%;
            padding: 17px;
            margin-bottom: 19px;
            border: 1.5px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1.13rem;
            box-shadow: 0 1px 6px #0056b330;
            transition: border 0.2s;
        }
        .login-form input:focus {
            border: 2px solid #007bff;
            outline: none;
        }
        .password-container { position: relative; width: 100%; }
        .password-container input { padding-right: 40px; }
        .password-container .fa-eye, .password-container .fa-eye-slash {
            position: absolute; right: 16px; top: 50%;
            transform: translateY(-50%);
            cursor: pointer; color: #007bff; font-size: 1.2em;
        }
        .login-form button {
            width: 100%;
            padding: 15px;
            border: none;
            background: linear-gradient(90deg,#007bff 70%,#0056b3 100%);
            color: #fff;
            border-radius: 6px;
            font-size: 1.14rem;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 2px 8px #007bff30;
            margin-top: 6px;
            letter-spacing: 0.07em;
            transition: background 0.22s, box-shadow 0.2s;
        }
        .login-form button:hover {
            background: linear-gradient(90deg,#0056b3 60%,#007bff 100%);
            box-shadow: 0 4px 14px #007bff40;
        }
        #login-error {
            color: #dc3545;
            margin-top: 18px;
            font-size: 1.11em;
            display: none;
            text-align: center;
        }
        .hidden { display: none !important; }

        /* --- HEADER & MAIN --- */
        .header-bar { background: #fff; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px #0001;}
        .header-title { font-size: 1.7rem; color: #0056b3; font-weight: bold;}
        .header-update {
            color: #6c757d;
            font-size: 1em;
            margin-top: 2px;
            margin-bottom: 4px;
        }
        .header-right { display: flex; align-items: center; gap: 15px;}
        .logout-logo { width: 48px; height: 48px; border-radius: 50%; object-fit: contain; background: #fff; border: 1px solid #ddd;}
        .logout-button { background: #dc3545; color: #fff; border: none; border-radius: 25px; padding: 10px 22px; font-size: 1.1rem; font-weight: 600; cursor: pointer; text-transform: uppercase; transition: background 0.3s;}
        .logout-button:hover { background: #b71c1c; }

        .main-content { flex: 1 1 auto; display: flex; flex-direction: column; min-width: 0; min-height: 0; padding: 24px 18px 10px 18px; gap: 14px; background: #f0f2f5;}

        /* Statistiques ruban */
        .stats-ribbon {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 28px;
            margin-bottom: 15px;
            background: #fff;
            padding: 18px 0 12px 0;
            border-radius: 9px;
            box-shadow: 0 2px 6px #0001;
        }
        .stat-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        .stat-label {
            font-size: 1.16em;
            color: #666;
            letter-spacing: 0.02em;
            font-weight: 500;
        }
        .stat-value {
            font-size: 2.1em;
            font-weight: bold;
            margin: 2px 0 0 0;
            color: #0056b3;
            letter-spacing: 0.02em;
        }
        .stat-r { color: #28a745 !important; }
        .stat-nr { color: #dc3545 !important; }
        .stat-blue { color: #007bff !important; }

        .header-text { margin-bottom: 4px;}
        .header-text h1 { color: #0056b3; margin: 0 0 5px 0; font-size: 1.35rem;}
        #last-updated { color: #6c757d; font-size: 0.82rem; margin-bottom: 8px;}
        .subtitle { color: #6c757d; font-size: 0.95rem; margin-bottom: 10px; }

        /* SEARCH */
        .search-panel { background: #fff; padding: 17px 15px 7px 15px; border-radius: 10px; box-shadow: 0 1px 4px #0002; display: flex; flex-direction: column; gap: 12px;}
        .filters-form { display: flex; align-items: center; gap: 11px; flex-wrap: wrap; }
        .filters-form .search-box { position: relative; }
        .filters-form .search-box input { width: 170px; padding: 8px 16px 8px 34px; border: 1px solid #ced4da; border-radius: 25px; font-size: 0.98em; background: #f6f8fa;}
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6c757d; font-size: 1em;}
        .action-buttons-aligned { display: flex; gap: 8px; margin-left: 8px;}
        #exportPdfButton { background: #e74c3c; color: #fff; }
        #showAllButton { background: #2ecc71; color: #fff; }
        .action-button { padding: 7px 13px; border: none; border-radius: 23px; font-size: 0.98em; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px #0001; text-transform: uppercase; display: flex; align-items: center; gap: 5px; transition: all 0.2s;}
        .action-button:hover { opacity: 0.9; transform: translateY(-2px) scale(1.02);}

        /* --- TABLEAU ZOOM + HEADER STICKY --- */
        .table-sticky-header {
            position: sticky;
            top: 80px; /* hauteur du header-bar (~65px + espace) */
            z-index: 20;
            background: #f0f2f5;
            padding-top: 7px;
            padding-bottom: 2px;
            box-shadow: 0 1px 8px #0001;
        }
        .zoom-controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 3px;
        }
        .table-container {
            height: 400px;
            max-height: 400px;
            overflow: auto;
            margin-top: 0;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px #0002;
            padding: 8px 2px;
        }
        #dataDisplay {
            transition: transform 0.15s;
            max-width: 100%;
        }
        .table-auto { border-collapse: collapse; width: 100%; table-layout: fixed; background: #fff;}
        .table-auto th, .table-auto td { border: 1px solid #dee2e6; padding: 7px 2px; background: #fff; font-size: 1em; vertical-align: middle; word-break: break-word; overflow: hidden;}
        .table-auto th {
            position: sticky;
            top: 0;
            background: #e9ecef;
            z-index: 10;
            box-shadow: 0 2px 4px #0002;
        }
        .status-cell { font-weight: bold; color: #fff; border-radius: 4px;}
        .status-green { background: #28a745; }
        .status-red { background: #dc3545; }
        .no-data-message { color: #6c757d; font-style: italic; font-size: 1.05em; padding: 20px; text-align: center;}
        .table-auto th, .table-auto td { width: calc(100% / 11); }
        .table-auto th, .table-auto td, table th, table td {
            text-align: center !important;
            vertical-align: middle !important;
        }
        /* Agrandir et aligner à gauche la colonne POLE (2e colonne) */
        .table-auto td:nth-child(2), table td:nth-child(2) {
            min-width: 180px !important; width: 180px !important; max-width: 260px !important;
            text-align: left !important; padding-left: 14px !important;
        }
        .table-auto th:nth-child(2), table th:nth-child(2) {
            min-width: 180px !important; width: 180px !important; max-width: 260px !important;
            text-align: center !important;
        }
        /* ENTITE (3e colonne) */
        .table-auto td:nth-child(3), table td:nth-child(3) {
            min-width: 220px !important; width: 220px !important; max-width: 320px !important;
            text-align: left !important; padding-left: 14px !important;
        }
        .table-auto th:nth-child(3), table th:nth-child(3) {
            min-width: 220px !important; width: 220px !important; max-width: 320px !important;
            text-align: center !important;
        }
        /* DEBUT */
        .table-auto th:nth-child(4), .table-auto td:nth-child(4), table th:nth-child(4), table td:nth-child(4) {
            min-width: 130px !important; width: 130px !important; max-width: 180px !important;
        }
        /* FIN */
        .table-auto th:nth-child(5), .table-auto td:nth-child(5), table th:nth-child(5), table td:nth-child(5) {
            min-width: 130px !important; width: 130px !important; max-width: 180px !important;
        }
        /* DUREE */
        .table-auto th:nth-child(6), .table-auto td:nth-child(6), table th:nth-child(6), table td:nth-child(6) {
            min-width: 110px !important; width: 110px !important; max-width: 160px !important;
        }
        /* RESPONSABLE */
        .table-auto th:nth-child(7), .table-auto td:nth-child(7), table th:nth-child(7), table td:nth-child(7) {
            min-width: 180px !important; width: 180px !important; max-width: 260px !important;
            text-align: left !important; padding-left: 14px !important;
        }
        /* AUDITEUR 1 */
        .table-auto th:nth-child(8), .table-auto td:nth-child(8), table th:nth-child(8), table td:nth-child(8) {
            min-width: 170px !important; width: 170px !important; max-width: 240px !important;
            text-align: left !important; padding-left: 14px !important;
        }
        /* AUDITEUR 2 */
        .table-auto th:nth-child(9), .table-auto td:nth-child(9), table th:nth-child(9), table td:nth-child(9) {
            min-width: 170px !important; width: 170px !important; max-width: 240px !important;
            text-align: left !important; padding-left: 14px !important;
        }

        @media (max-width: 1100px) {
            .main-content { padding: 8px; }
            .stat-block { min-width: 100px; }
            .login-container { max-width: 98vw; }
        }
        @media (max-width: 900px) {
            .main-content { padding: 7px 3px; }
            .stats-ribbon { flex-direction: column; gap: 8px; }
        }
        @media (max-width: 650px) {
            .header-bar { flex-direction: column; gap: 10px; padding: 10px 5px;}
            .main-content { padding: 3px;}
            .search-panel { padding: 7px 4px;}
            .filters-form .search-box input { width: 90px;}
            .stat-block { min-width: 70px; }
            .login-container { padding: 16px 4vw 16px 4vw; min-width: unset; }
        }
        .login-header {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.login-header img {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.login-container h2 {
    color: #6c757d;
    font-size: 1.15rem;
    font-weight: bold;
    margin-bottom: 32px;
    text-transform: uppercase;
    letter-spacing: 0.11em;
    text-align: center; /* Centrage horizontal */
    width: 100%;
}
    </style>
</head>
<body>
<div class="wrapper">
    <!-- Login -->
    <div id="login-page" class="login-container">
        <div class="login-header">
            <img src="LOGO_DMS-removebg-preview.png" alt="Logo DMS" class="logo">
            <h1>Mon programme</h1>
            <h2>D'AUDIT INTERNE 2025</h2>
        </div>
        <form id="login-form" class="login-form">
            <input type="text" id="username" placeholder="Nom d'utilisateur" required>
            <div class="password-container">
                <input type="password" id="password" placeholder="Mot de passe" required>
                <i class="fas fa-eye" id="toggle-password"></i>
            </div>
            <button type="submit">Se connecter</button>
        </form>
        <p id="login-error"></p>
    </div>
    <!-- Main -->
    <div id="main-content" class="hidden">
        <div class="header-bar">
            <div>
                <div class="header-title">Mon programme d'audit interne 2025</div>
                <div class="header-update">Dernière mise à jour le 11/08/2025</div>
            </div>
            <div class="header-right">
                <img src="LOGO_DMS-removebg-preview.png" alt="Logo DMS" class="logout-logo">
                <button id="logout-button" class="logout-button">Se déconnecter</button>
            </div>
        </div>
        <div class="main-content">
            
            <div class="stats-ribbon">
                <div class="stat-block">
                    <span class="stat-label">Missions Réalisées</span>
                    <span class="stat-value stat-r" id="realized-missions">0</span>
                </div>
                <div class="stat-block">
                    <span class="stat-label">Missions Non Réalisées</span>
                    <span class="stat-value stat-nr" id="unrealized-missions">0</span>
                </div>
                <div class="stat-block">
                    <span class="stat-label">Rapports Diffusés</span>
                    <span class="stat-value stat-r" id="diffuse-reports">0</span>
                </div>
                <div class="stat-block">
                    <span class="stat-label">Rapports Non diffusés</span>
                    <span class="stat-value stat-nr" id="non-diffuse-reports">0</span>
                </div>
                <div class="stat-block">
                    <span class="stat-label">Total Missions</span>
                    <span class="stat-value stat-blue" id="total-missions">0</span>
                </div>
            </div>
            <div class="header-text">
                <h1>Cherchez Votre Programme</h1>
               
                <div class="subtitle">Entrez un nom ou un mot-clé pour trouver votre programme.</div>
            </div>
            <div class="search-panel">
                <form id="search-form" class="filters-form" onsubmit="return false;">
                    <div class="search-box">
                        <i class="fas fa-user-friends search-icon"></i>
                        <input type="text" id="searchName" placeholder="Rechercher par responsable ou auditeur...">
                    </div>
                    <div class="search-box">
                        <i class="fas fa-building search-icon"></i>
                        <input type="text" id="searchSociety" placeholder="Rechercher par société...">
                    </div>
                    <div class="search-box">
                        <i class="fas fa-sitemap search-icon"></i>
                        <input type="text" id="searchPole" placeholder="Rechercher par pôle...">
                    </div>
                    <div class="action-buttons-aligned">
                        <button type="button" id="exportPdfButton" class="action-button" title="Exporter les résultats en PDF">
                            <i class="fas fa-file-pdf"></i>Exporter PDF
                        </button>
                        <button type="button" id="showAllButton" class="action-button" title="Voir tout le programme">
                            <i class="fas fa-list"></i>Tout afficher
                        </button>
                    </div>
                </form>
            </div>
            <!-- Sticky Zoom + Tableau -->
            <div class="table-sticky-header">
                <div class="zoom-controls">
                    <button id="zoomInBtn" class="action-button" title="Zoomer le tableau" style="background:#007bff; color:#fff;"><i class="fas fa-search-plus"></i> Zoom +</button>
                    <button id="zoomOutBtn" class="action-button" title="Dézoomer le tableau" style="background:#007bff; color:#fff;"><i class="fas fa-search-minus"></i> Zoom -</button>
                    <button id="resetZoomBtn" class="action-button" title="Réinitialiser le zoom" style="background:#6c757d; color:#fff;"><i class="fas fa-compress"></i> Reset</button>
                </div>
            </div>
            <div class="table-container" id="table-content">
                <div id="dataDisplay"></div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
// --- Variables et identifiants privés ---
const SPREADSHEET_ID = '1JsbNg0BbuNP94tXtS09X6qbGv8Cf2hKUWUzZJbzeOVI';
const API_KEY = 'AIzaSyAfJDEkFh0J9K0ngYPgtYhOs5P_Q8WEyTc';
const USERNAME = 'Auditeurin2025';
const PASSWORD = 'SDAUDITP2025@';
const SHEET_NAME = 'PROGRAMME';
const RANGE_DATA = 'A6:K';
const RANGE_DATE = 'A4:A4';
const TABLE_HEADERS = ["SOCIETE", "POLE", "ENTITE", "DEBUT", "FIN", "DUREE", "RESPONSABLE", "AUDITEUR 1", "AUDITEUR 2", "STATUT", "RAPPORT"];
let allData = [];
let currentFilteredData = [];
let filterTimeout;

document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('login-form');
    const loginPage = document.getElementById('login-page');
    const mainContent = document.getElementById('main-content');
    const loginError = document.getElementById('login-error');
    const logoutButton = document.getElementById('logout-button');
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    const searchName = document.getElementById('searchName');
    const searchSociety = document.getElementById('searchSociety');
    const searchPole = document.getElementById('searchPole');
    const exportPdfButton = document.getElementById('exportPdfButton');
    const showAllButton = document.getElementById('showAllButton');
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const usernameInput = document.getElementById('username').value;
        const passwordInputVal = passwordInput.value;
        if (usernameInput === USERNAME && passwordInputVal === PASSWORD) {
            loginPage.classList.add('hidden');
            mainContent.classList.remove('hidden');
            fetchGoogleSheetData();
            fetchLastUpdatedDate();
            displayMessage("Veuillez commencer à taper pour voir les résultats.");
        } else {
            loginError.textContent = 'Nom d\'utilisateur ou mot de passe incorrect.';
            loginError.style.display = 'block';
        }
    });
    logoutButton.addEventListener('click', () => {
        mainContent.classList.add('hidden');
        loginPage.classList.remove('hidden');
        document.getElementById('username').value = '';
        passwordInput.value = '';
        loginError.style.display = 'none';
        searchName.value = '';
        searchSociety.value = '';
        searchPole.value = '';
        displayMessage("Veuillez commencer à taper pour voir les résultats.");
        updateStats(allData);
    });
    togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePassword.classList.toggle('fa-eye-slash');
    });
    searchName.addEventListener('input', triggerFilter);
    searchSociety.addEventListener('input', triggerFilter);
    searchPole.addEventListener('input', triggerFilter);
    exportPdfButton.addEventListener('click', () => exportToPdf(currentFilteredData));
    showAllButton.addEventListener('click', showAllData);
});
function triggerFilter() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(filterData, 200);
}
async function fetchGoogleSheetData() {
    try {
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE_DATA}?key=${API_KEY}`;
        const dataResponse = await fetch(dataUrl);
        if (!dataResponse.ok) throw new Error(`Erreur HTTP: ${dataResponse.status}`);
        const data = await dataResponse.json();
        allData = data.values || [];
        sortDataByDate(allData);
        updateStats(allData);
    } catch (error) {
        displayMessage("Erreur lors du chargement des données. Veuillez vérifier la connexion.");
    }
}
function sortDataByDate(data) {
    const dateIndex = 3;
    data.sort((a, b) => parseDate(a[dateIndex]) - parseDate(b[dateIndex]));
}
function parseDate(dateString) {
    if (!dateString) return new Date(0);
    const parts = dateString.split('/');
    if (parts.length !== 3) return new Date(0);
    return new Date(parts[2], parts[1] - 1, parts[0]);
}
async function fetchLastUpdatedDate() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE_DATE}?key=${API_KEY}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        const data = await response.json();
        const dateElement = document.getElementById('last-updated');
        if (data.values && data.values.length > 0) {
            const date = data.values[0][0];
            dateElement.textContent = `Dernière mise à jour le ${date}`;
        } else {
            dateElement.textContent = 'Date non disponible';
        }
    } catch (error) {
        document.getElementById('last-updated').textContent = "Erreur de chargement de la date";
    }
}
function updateStats(data) {
    if (!data) return;
    let totalMissions = data.length, realizedMissions = 0, unrealizedMissions = 0, diffusedReports = 0, nonDiffusedReports = 0;
    const statutIndex = 9, rapportIndex = 10;
    data.forEach(row => {
        const missionStatus = String(row[statutIndex] || '').toLowerCase().trim();
        const rapportStatus = String(row[rapportIndex] || '').toLowerCase().trim();
        if (["r", "réalisé", "réalisée"].includes(missionStatus)) realizedMissions++;
        else if (["nr", "non réalisé", "non réalisée"].includes(missionStatus)) unrealizedMissions++;
        if (rapportStatus === 'diffusé') diffusedReports++;
        if ((["r", "réalisé", "réalisée"].includes(missionStatus)) && rapportStatus === 'non diffusé') nonDiffusedReports++;
    });
    document.getElementById('total-missions').textContent = totalMissions;
    document.getElementById('realized-missions').textContent = realizedMissions;
    document.getElementById('unrealized-missions').textContent = unrealizedMissions;
    document.getElementById('diffuse-reports').textContent = diffusedReports;
    document.getElementById('non-diffuse-reports').textContent = nonDiffusedReports;
}
function displayData(dataToDisplay) {
    const dataDisplayElement = document.getElementById('dataDisplay');
    dataDisplayElement.innerHTML = '';
    if (!dataToDisplay || dataToDisplay.length === 0) {
        displayMessage("Aucun résultat ne correspond à votre recherche.");
        return;
    }
    const tableDiv = createTable(dataToDisplay);
    dataDisplayElement.appendChild(tableDiv);
}
function filterData() {
    const nameFilterValue = document.getElementById('searchName').value.trim().toLowerCase();
    const societyFilterValue = document.getElementById('searchSociety').value.trim().toLowerCase();
    const poleFilterValue = document.getElementById('searchPole').value.trim().toLowerCase();
    if (nameFilterValue === '' && societyFilterValue === '' && poleFilterValue === '') {
        displayMessage("Veuillez commencer à taper pour voir les résultats.");
        updateStats(allData);
        currentFilteredData = [];
        return;
    }
    if (allData.length === 0) return;
    const filtered = allData.filter(row => {
        const societyCell = String(row[0] || '').toLowerCase();
        const poleCell = String(row[1] || '').toLowerCase();
        const nameCellE = String(row[6] || '').toLowerCase();
        const nameCellF = String(row[7] || '').toLowerCase();
        const nameCellG = String(row[8] || '').toLowerCase();
        const nameMatch = nameFilterValue === '' || nameCellE.includes(nameFilterValue) || nameCellF.includes(nameFilterValue) || nameCellG.includes(nameFilterValue);
        const societyMatch = societyFilterValue === '' || societyCell.includes(societyFilterValue);
        const poleMatch = poleFilterValue === '' || poleCell.includes(poleFilterValue);
        return nameMatch && societyMatch && poleMatch;
    });
    sortDataByDate(filtered);
    currentFilteredData = filtered;
    displayData(filtered);
    updateStats(filtered);
}
function displayMessage(message) {
    const dataDisplayElement = document.getElementById('dataDisplay');
    dataDisplayElement.innerHTML = `<div class="no-data-message">${message}</div>`;
}
function exportToPdf(dataToExport) {
    if (!dataToExport || dataToExport.length === 0) {
        alert("Aucune donnée à exporter.");
        return;
    }
    // Création d'un conteneur temporaire pour le PDF
    const tempContainer = document.createElement('div');
    tempContainer.style.padding = '15px';
    tempContainer.style.width = '2200px'; // Largeur très grande pour toutes les colonnes
    tempContainer.style.maxWidth = 'none';
    tempContainer.style.overflowX = 'auto';

    // Logo centré
    const logo = document.createElement('img');
    logo.src = "LOGO_DMS-removebg-preview.png";
    logo.style.display = "block";
    logo.style.margin = "0 auto 10px auto";
    logo.style.width = "120px";
    tempContainer.appendChild(logo);

    // Date et heure de téléchargement centrées
    const now = new Date();
    const dateTime = now.toLocaleDateString('fr-FR') + " " + now.toLocaleTimeString('fr-FR');
    const datePara = document.createElement('div');
    datePara.style.textAlign = "center";
    datePara.style.marginBottom = "10px";
    datePara.style.fontSize = "1.1em";
    datePara.innerHTML = `<strong>Téléchargé le :</strong> ${dateTime}`;
    tempContainer.appendChild(datePara);

    // Titre centré
    const title = document.createElement('h2');
    title.textContent = "Programme d'audit interne 2025";
    title.style.textAlign = 'center';
    title.style.marginBottom = '18px';
    tempContainer.appendChild(title);

    // Tableau adapté pour le PDF (centré, large)
    const table = document.createElement('table');
    table.style.borderCollapse = 'collapse';
    table.style.width = '2200px'; // Largeur très grande
    table.style.maxWidth = 'none';
    table.style.tableLayout = 'auto';
    table.style.fontSize = "0.95em";
    table.style.marginTop = "10px";
    table.style.overflowX = "auto";

    // Thead
    const TABLE_HEADERS = ["SOCIETE", "POLE", "ENTITE", "DEBUT", "FIN", "DUREE", "RESPONSABLE", "AUDITEUR 1", "AUDITEUR 2", "STATUT", "RAPPORT"];
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    TABLE_HEADERS.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        th.style.border = '1px solid #999';
        th.style.background = '#e9ecef';
        th.style.padding = '4px';
        th.style.textAlign = 'center';
        th.style.fontWeight = 'bold';
        th.style.width = "200px"; // largeur fixe pour chaque colonne
        th.style.wordBreak = "break-word";
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Tbody
    const tbody = document.createElement('tbody');
    dataToExport.forEach(rowData => {
        const tr = document.createElement('tr');
        rowData.forEach((cellData, index) => {
            const td = document.createElement('td');
            td.textContent = cellData;
            td.style.border = '1px solid #999';
            td.style.padding = '3px 2px';
            td.style.wordBreak = "break-word";
            td.style.textAlign = "center";
            td.style.width = "200px";
            // Statut coloré
            if(index===9) {
                td.style.background = "#28a745";
                td.style.color = "#fff";
                td.style.fontWeight = "bold";
            } else if(index===10) {
                const rapportStatus = String(cellData || '').toLowerCase().trim();
                td.style.fontWeight = "bold";
                if (rapportStatus === 'diffusé') {
                    td.style.background = "#28a745";
                    td.style.color = "#fff";
                } else if (rapportStatus === 'non diffusé') {
                    td.style.background = "#dc3545";
                    td.style.color = "#fff";
                }
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    tempContainer.appendChild(table);

    // Options html2pdf
    const options = {
        margin: [10, 10, 10, 10],
        filename: 'programme_audit_interne.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3 }, // Résolution élevée
        jsPDF: { unit: 'mm', format: 'a2', orientation: 'landscape' }, // Format large paysage
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().set(options).from(tempContainer).save();
}
function showAllData() {
    document.getElementById('searchName').value = '';
    document.getElementById('searchSociety').value = '';
    document.getElementById('searchPole').value = '';
    displayData(allData);
    updateStats(allData);
    currentFilteredData = allData;
}
function createTable(dataToDisplay) {
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    const headerRow = document.createElement('tr');
    TABLE_HEADERS.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    dataToDisplay.forEach(rowData => {
        const tr = document.createElement('tr');
        rowData.forEach((cellData, index) => {
            const td = document.createElement('td');
            td.textContent = cellData;

            const statutIndex = 9;
            const rapportIndex = 10;

            if (index === statutIndex) {
                const status = String(cellData || '').toLowerCase().trim();
                td.classList.add('status-cell');
                if (status === 'r') {
                    td.classList.add('status-green');
                } else if (status === 'nr') {
                    td.classList.add('status-red');
                }
            } else if (index === rapportIndex) {
                const rapportStatus = String(cellData || '').toLowerCase().trim();
                td.classList.add('status-cell');
                if (rapportStatus === 'diffusé') {
                    td.classList.add('status-green');
                } else if (rapportStatus === 'non diffusé') {
                    td.classList.add('status-red');
                }
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    return table;
}
// --- Fonction zoom du tableau ---
let currentZoom = 1;
const minZoom = 0.5;
const maxZoom = 2.5;
const zoomStep = 0.1;

function updateTableZoom() {
    const dataDisplay = document.getElementById('dataDisplay');
    dataDisplay.style.transform = `scale(${currentZoom})`;
    dataDisplay.style.transformOrigin = "top left";
}

document.getElementById('zoomInBtn').addEventListener('click', () => {
    if (currentZoom < maxZoom) {
        currentZoom += zoomStep;
        updateTableZoom();
    }
});
document.getElementById('zoomOutBtn').addEventListener('click', () => {
    if (currentZoom > minZoom) {
        currentZoom -= zoomStep;
        updateTableZoom();
    }
});
document.getElementById('resetZoomBtn').addEventListener('click', () => {
    currentZoom = 1;
    updateTableZoom();
});
</script>
</body>
</html>
